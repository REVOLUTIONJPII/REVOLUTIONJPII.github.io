<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Clubes Estudiantiles - Revolution JPII</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#061026;
    --card1:#0a1a33;
    --card2:#102445;
    --accent:#1e90ff;
    --accent-2:#00c6ff;
    --muted:#cfe8ff;
    --glass: rgba(255,255,255,0.03);
    --danger:#e74c3c;
    --success:#16a34a;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:"Montserrat",sans-serif; background:
      radial-gradient(1200px 400px at 10% 10%, rgba(30,50,90,0.28), transparent),
      linear-gradient(180deg,var(--bg), #021024 140%);
    color: #f4fbff;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  body::before{
    content:""; position:fixed; inset:0; background-image: url("https://www.transparenttextures.com/patterns/diamond-upholstery.png");
    opacity:0.04; pointer-events:none; z-index:0;
  }

  /* header */
  header{
    position:fixed; top:0; left:0; right:0; height:72px;
    background: linear-gradient(90deg, rgba(3,18,45,0.9), rgba(6,28,64,0.95));
    border-bottom: 1px solid rgba(255,255,255,0.04);
    display:flex; align-items:center; justify-content:space-between; padding:0 22px; z-index:60;
    box-shadow: 0 6px 24px rgba(0,0,0,0.6);
    backdrop-filter: blur(6px);
  }
  .logo{font-weight:800; color:var(--accent); font-size:1.15rem; cursor:pointer; display:flex; align-items:center; gap:10px}
  .logo .spark{font-size:1.25rem; filter: drop-shadow(0 0 8px rgba(0,198,255,0.12))}
  .logo:hover{transform:translateY(-2px); text-shadow:0 0 12px rgba(0,198,255,0.08)}

  nav ul{list-style:none; display:flex; gap:18px; margin:0; padding:0; align-items:center}
  nav a{color:#eaf6ff; text-decoration:none; font-weight:600; opacity:0.95; padding:8px 10px; border-radius:8px}
  nav a:hover{color:var(--accent-2); background: linear-gradient(90deg, rgba(255,255,255,0.02), transparent); box-shadow: inset 0 0 12px rgba(0,198,255,0.02)}

  /* layout */
  .wrap{
    max-width:1200px; margin:104px auto 48px; padding:0 18px;
    display:grid; grid-template-columns: 2fr 1fr; gap:20px;
    z-index:10;
  }
  @media(max-width:980px){
    .wrap{grid-template-columns:1fr; margin-top:96px}
  }

  /* page title */
  .page-title{
    grid-column:1/3; text-align:center; margin-bottom:8px;
  }
  .page-title h1{
    font-size:2.3rem; color:var(--accent-2); margin:0; font-weight:800;
    text-shadow: 2px 2px 6px rgba(0,10,30,0.8), 0 0 18px rgba(0,198,255,0.12);
  }
  .page-title p{color:var(--muted); margin-top:8px}

  /* intro */
  .intro{
    grid-column:1/3; background: linear-gradient(135deg,var(--card1),var(--card2));
    padding:20px; border-radius:14px; box-shadow:0 14px 40px rgba(2,8,20,0.6);
    text-align:center; border: 1px solid rgba(255,255,255,0.03);
  }
  .intro p{
    color:var(--muted); font-size:1.05rem; line-height:1.6; margin:0 auto; max-width:1000px;
    text-shadow: 0 2px 8px rgba(0,0,0,0.6);
  }

  /* left column */
  .left{display:flex; flex-direction:column; gap:16px}

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px; padding:14px; box-shadow:0 8px 28px rgba(0,0,0,0.6); transition:all .28s;
    border:1px solid rgba(255,255,255,0.03);
  }
  .card:hover{transform:translateY(-6px); box-shadow:0 20px 45px rgba(0,0,0,0.7)}

  .card h3{margin:0 0 10px; color:var(--accent-2); font-size:1.05rem}
  .muted{color:var(--muted); font-size:0.95rem}

  .row{display:flex; gap:10px; align-items:center}
  .input, textarea, select{
    width:100%; padding:11px 12px; border-radius:10px; border:none; background:var(--glass); color:#f5faff;
    outline:none; font-size:0.98rem; box-shadow: inset 0 2px 10px rgba(0,0,0,0.45);
  }
  textarea{min-height:110px; resize:vertical}

  .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .btn{
    background: linear-gradient(135deg,var(--accent), #003366); color:#fff; padding:10px 14px; border-radius:10px; border:none;
    font-weight:700; cursor:pointer; transition:all .18s; box-shadow: 0 8px 20px rgba(0,0,0,0.5);
  }
  .btn:hover{transform:translateY(-3px); box-shadow:0 12px 28px rgba(0,0,0,0.6)}
  .btn.ghost{background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); font-weight:600}

  /* feed */
  #feed{display:flex; flex-direction:column; gap:12px}
  .post{
    padding:12px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.03); box-shadow: 0 8px 28px rgba(0,0,0,0.55);
  }
  .post .meta{display:flex; justify-content:space-between; align-items:center; gap:8px}
  .author{font-weight:700; color:var(--accent-2)}
  .time{color:#aabbee; font-size:0.9rem}
  .text{margin:10px 0; color:var(--muted); white-space:pre-wrap}
  .post img{max-width:100%; border-radius:10px; margin-top:8px; display:block; box-shadow: 0 8px 24px rgba(0,0,0,0.6)}

  .actions{display:flex; gap:8px; margin-top:10px}
  .actions button{background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:8px 10px; border-radius:8px; cursor:pointer}
  .actions button:hover{color:#fff; border-color:rgba(0,198,255,0.12); box-shadow:0 10px 20px rgba(0,198,255,0.06)}

  .comments{margin-top:12px; border-top:1px solid rgba(255,255,255,0.03); padding-top:10px}
  .comment{display:flex; gap:10px; align-items:flex-start; margin-bottom:8px}
  .comment .who{font-weight:700; color:var(--accent)}
  .comment .what{color:var(--muted)}

  .smallbtn{background:transparent;border:none;color:#aabbee;cursor:pointer;font-size:0.95rem}

  /* right sidebar */
  .right{display:flex; flex-direction:column; gap:12px; position:sticky; top:92px; align-self:start}
  .sidebar-title{text-align:center; color:var(--accent-2); font-weight:800; margin-bottom:8px}

  .club-list{display:flex; flex-direction:column; gap:10px; max-height:62vh; overflow:auto; padding-right:6px}
  .club{
    display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px; border-radius:12px;
    background: linear-gradient(135deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border:1px solid rgba(255,255,255,0.03)
  }
  .club .info{flex:1; cursor:pointer}
  .club h4{margin:0; color:var(--accent); font-size:1rem}
  .club p{margin:4px 0 0;color:#aabbee;font-size:0.85rem}
  .club .meta-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
  .club .count{color:#bcdcff; font-size:0.9rem}
  .club button{background:var(--danger);border:none;color:#fff;padding:6px 8px;border-radius:8px;cursor:pointer;font-size:0.85rem}
  .club button:hover{background:#c0392b}

  /* camera modal */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,0.65); display:none; align-items:center; justify-content:center; z-index:200; padding:12px}
  .cambox{background: linear-gradient(180deg,var(--card1),var(--card2)); padding:12px; border-radius:12px; max-width:820px; width:100%}
  video{width:100%; border-radius:8px; background:#000; display:block}
  .cam-actions{display:flex; gap:8px; margin-top:8px; justify-content:flex-end}

  .file-preview{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .thumb{position:relative; width:120px}
  .thumb img{width:120px; height:80px; object-fit:cover; border-radius:8px; display:block}
  .thumb .del{position:absolute; right:6px; top:6px; background:rgba(0,0,0,0.6); border:none; color:#fff; padding:4px 6px; border-radius:6px; cursor:pointer}

  .members-list{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .member-pill{background: rgba(255,255,255,0.03); padding:6px 8px; border-radius:999px; color:var(--muted); font-weight:600; font-size:0.9rem}

  .note{color:#bcdcff; font-size:0.9rem}

  /* registration overlay */
  .overlay{position:fixed; inset:0; background:linear-gradient(180deg, rgba(0,0,0,0.7), rgba(0,0,0,0.85)); display:flex; align-items:center; justify-content:center; z-index:999}
  .regbox{background: linear-gradient(180deg,var(--card1),var(--card2)); padding:20px; border-radius:12px; width:400px; max-width:95%; box-shadow:0 20px 50px rgba(0,0,0,0.7); border:1px solid rgba(255,255,255,0.03)}
  .regbox h2{margin:0 0 8px; color:var(--accent-2)}
  .regbox p{color:var(--muted); margin-bottom:12px; font-size:0.95rem}

  @media(max-width:560px){
    header{padding:0 12px}
    .logo{font-size:1rem}
    .wrap{padding:0 12px}
    .club .meta-right{align-items:center}
  }

  /* === ADICIONES: detectar móvil y FAB (no cambian tus colores/opciones) === */
  /* FAB estilo (oculto por defecto) */
  #rjpii_fab {
    display: none;
    position: fixed;
    z-index: 1200;
    right: 18px;
    bottom: 18px;
    width: 56px;
    height: 56px;
    border-radius: 999px;
    background: linear-gradient(135deg,var(--accent), var(--accent-2));
    box-shadow: 0 10px 28px rgba(0,0,0,0.6);
    color: white;
    font-size: 28px;
    border: none;
    cursor: pointer;
  }

  /* small adjustments when body has .rjpii-mobile */
  body.rjpii-mobile header{ height: auto; padding:12px; }
  body.rjpii-mobile .right{ display: none !important; } /* ocultar sidebar en móvil */
  body.rjpii-mobile .wrap{ margin-top:86px; } /* ajustar top spacing */
  body.rjpii-mobile .btn{ padding:12px 14px; font-size:1rem; }

  @media(max-width:768px){
    #rjpii_fab { display: block; } /* mostrar fab en pantallas chicas */
  }
  /* === FIN ADICIONES === */

</style>
</head>
<body>

<header>
  <div class="logo" onclick="scrollToTop()"><span class="spark">⚡</span> Revolution JPII</div>
  <nav>
    <ul>
      <li><a href="#" onclick="scrollToSection('home')">Inicio</a></li>
      <li><a href="#" onclick="scrollToSection('clubes')">Clubes</a></li>
      <li><a href="#" onclick="scrollToSection('feed')">Feed</a></li>
    </ul>
  </nav>
</header>

<main class="wrap" id="clubes">

  <!-- TITLE -->
  <section class="page-title">
    <h1>Clubes Estudiantiles</h1>
    <p>Comparte, aprende y participa. Crea o únete a clubes, publica fotos y archivos, comenta y colabora.</p>
  </section>

  <!-- INTRO (full width) -->
  <section class="intro card" id="home" aria-label="introduccion">
    <p>
      <strong>El talento está en todos los juanpablinos</strong>, solo hace falta abrir espacios para compartirlo.
      En los clubes, los alumnos podrán aprender de otros compañeros distintas disciplinas como
      ajedrez, fútbol, vóley, básquet, canto, pintura, danza, matemáticas o ciencias. Así,
      se fomenta el trabajo en equipo, la preparación para los Juegos Deportivos y el desarrollo
      de nuevas pasiones. Crea y únete a clubes, comparte publicaciones con fotos o archivos y conecta con la comunidad.
    </p>
  </section>

  <!-- LEFT: forms + feed -->
  <section class="left">

    <!-- create group -->
    <div class="card" id="formCreateGroup">
      <h3>➕ Crear nuevo club</h3>
      <div style="display:flex;gap:8px;flex-direction:column;margin-top:8px">
        <input id="creatorName" class="input" placeholder="Tu nombre (serás el creador / dueño)">
        <input id="newGroupName" class="input" placeholder="Nombre del club (ej: Club de Ajedrez)">
        <input id="newGroupDesc" class="input" placeholder="Descripción breve (opcional)">
        <div class="row" style="justify-content:flex-end">
          <button class="btn" onclick="createGroup()">Crear club</button>
        </div>
        <div class="note" style="margin-top:8px">Los clubs serán visibles a toda la comunidad. Solo el creador (dueño) podrá eliminar su club (se pedirá confirmar nombre).</div>
      </div>
    </div>

    <!-- create post -->
    <div class="card" id="formCreatePost">
      <h3>📝 Crear entrada</h3>

      <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">
        <select id="postGroupSelect" class="input" style="max-width:260px">
          <option value="">-- Selecciona club (opcional) --</option>
        </select>
        <input id="postAuthor" class="input" placeholder="Tu nombre (requerido)" />
      </div>

      <textarea id="postText" placeholder="¿Qué quieres compartir?" ></textarea>

      <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
        <label class="btn ghost" for="postFileInput">📎 Adjuntar archivo</label>
        <input id="postFileInput" type="file" style="display:none">
        <button class="btn" id="openCameraBtn" onclick="openCamera()">📷 Tomar foto</button>
        <button class="btn" onclick="createPost()">Crear entrada</button>
      </div>

      <div class="file-preview" id="postPreview"></div>
      <div class="note" style="margin-top:8px">Puedes subir imágenes (jpg/png/gif) o documentos (pdf, docx). Publicaciones con palabras prohibidas se bloquearán automáticamente.</div>
    </div>

    <!-- feed -->
    <div class="card" id="feedCard">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h3 id="feedTitle">📰 Feed</h3>
        <div class="controls">
          <select id="filterByGroup" class="input" style="max-width:220px">
            <option value="">Ver todo</option>
          </select>
          <input id="searchInput" class="input" placeholder="Buscar en publicaciones..." style="max-width:260px" />
          <button class="btn ghost" onclick="clearAll()">🧹 Limpiar datos (dev)</button>
        </div>
      </div>

      <div id="feed" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- RIGHT: sidebar clubs -->
  <aside class="right">
    <div class="card sidebar">
      <div class="sidebar-title">📌 Todos los clubes</div>
      <div id="clubList" class="club-list"></div>
      <div style="margin-top:10px; text-align:center;">
        <div class="note">Haz click en un club para filtrar; puedes unirte dando tu nombre y luego publicar dentro del club.</div>
      </div>
    </div>

    <div class="card">
      <h3>👥 Miembros del club</h3>
      <div id="selectedClubMembers" class="members-list">
        <div class="note">Selecciona un club para ver sus miembros.</div>
      </div>
    </div>
  </aside>

</main>

<!-- camera modal -->
<div id="cameraModal" class="modal" role="dialog" aria-modal="true">
  <div class="cambox card">
    <video id="cameraVideo" autoplay playsinline></video>
    <div class="cam-actions">
      <button class="btn ghost" onclick="closeCamera()">Cerrar</button>
      <button class="btn" onclick="capturePhoto()">📸 Capturar</button>
    </div>
  </div>
</div>

<!-- registration/login overlay -->
<div id="regOverlay" class="overlay" style="display:none">
  <div class="regbox">
    <h2 id="regTitle">Registro</h2>
    <p id="regMsg">⚠️ Solo podrás registrarte una vez en este navegador. El nombre no podrá cambiarse después. Introduce nombre y contraseña para crear tu cuenta local.</p>

    <div id="regForm">
      <input id="regName" class="input" placeholder="Tu nombre (ej: Juan Perez)" style="margin-bottom:8px">
      <input id="regPass" class="input" placeholder="Contraseña" type="password" style="margin-bottom:12px">
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn ghost" onclick="showLogin()">Ya tengo cuenta</button>
        <button class="btn" onclick="registerUser()">Registrarme</button>
      </div>
    </div>

    <div id="loginForm" style="display:none">
      <input id="loginName" class="input" placeholder="Nombre" style="margin-bottom:8px">
      <input id="loginPass" class="input" placeholder="Contraseña" type="password" style="margin-bottom:12px">
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn ghost" onclick="showRegister()">Crear cuenta</button>
        <button class="btn" onclick="loginUser()">Entrar</button>
      </div>
    </div>

    <p style="margin-top:12px;color:#cfe8ff;font-size:0.9rem">
      Nota: Guardamos tus credenciales en el navegador (localStorage). Para registrar IP real necesitas un backend: esto guarda un identificador único de tu dispositivo en esta máquina.
    </p>
  </div>
</div>

<!-- FLOATING ACTION BUTTON (FAB) para móviles -->
<button id="rjpii_fab" title="Crear entrada">＋</button>

<script>
/* =========================
   FULL APP: registration + clubs + feed + camera
   localStorage keys:
     rjpii_user_v1 -> {name, passHash, deviceId, createdAt}
     rjpii_groups_v2, rjpii_posts_v2
   ========================= */

const STORAGE_USER = 'rjpii_user_v1';
const STORAGE_GROUPS = 'rjpii_groups_v2';
const STORAGE_POSTS = 'rjpii_posts_v2';
const bannedWords = ['groseria','insulto','palabrota','maldicion','porno','spam']; // adjust

/* Helpers */
const uid = ()=> 'id'+Math.random().toString(36).slice(2,9);
const now = ()=> new Date().toISOString();

function loadJSON(k){ try{ return JSON.parse(localStorage.getItem(k) || 'null'); }catch(e){ return null; } }
function saveJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

/* Simple SHA-256 hashing for password using SubtleCrypto */
async function sha256hex(str){
  const enc = new TextEncoder();
  const data = enc.encode(str);
  const hash = await crypto.subtle.digest('SHA-256', data);
  const arr = Array.from(new Uint8Array(hash));
  return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* Device id (we can't get real public IP from static client), store userAgent + random id */
function makeDeviceId(){
  return btoa(navigator.userAgent + '|' + Math.random().toString(36) + '|' + Date.now()).slice(0,64);
}

/* Registration / Login UI logic */
const regOverlay = document.getElementById('regOverlay');
const regForm = document.getElementById('regForm');
const loginForm = document.getElementById('loginForm');

async function initAuth(){
  const user = loadJSON(STORAGE_USER);
  if(!user){
    // show register (first-time)
    regOverlay.style.display = 'flex';
    regTitleAndMsg(true);
    showRegister();
  } else {
    // user exists on this browser -> ask to login or if session present, auto-login
    const session = localStorage.getItem('rjpii_session');
    if(session === user.name){
      // auto logged in
      window.currentUser = user.name;
      afterLogin();
    } else {
      regOverlay.style.display = 'flex';
      regTitleAndMsg(false);
      showLoginDefault(user.name);
    }
  }
}
function regTitleAndMsg(firstTime){
  document.getElementById('regTitle').innerText = firstTime ? 'Registro (único)' : 'Accede a tu cuenta';
  document.getElementById('regMsg').innerText = firstTime
    ? '⚠️ Solo podrás registrarte una vez en este navegador. El nombre no podrá cambiarse después. Introduce nombre y contraseña.'
    : 'Introduce tus credenciales. Si ya te registraste en este navegador, usa tu nombre y contraseña.';
}
function showRegister(){ regForm.style.display='block'; loginForm.style.display='none'; document.getElementById('regName').focus(); }
function showLogin(){ regForm.style.display='none'; loginForm.style.display='block'; document.getElementById('loginName').focus(); }
function showLoginDefault(name){ showLogin(); if(name) document.getElementById('loginName').value = name; }

/* Register user (one account per browser) */
async function registerUser(){
  const name = document.getElementById('regName').value.trim();
  const pass = document.getElementById('regPass').value;
  if(!name || !pass) return alert('Nombre y contraseña requeridos.');
  if(containsBanned(name)) return alert('Nombre no permitido.');
  if(loadJSON(STORAGE_USER)) return alert('Ya hay una cuenta registrada en este navegador. Usar login.');
  const passHash = await sha256hex(pass);
  const deviceId = makeDeviceId();
  const user = { name, passHash, deviceId, createdAt: now() };
  saveJSON(STORAGE_USER, user);
  // create session
  localStorage.setItem('rjpii_session', name);
  window.currentUser = name;
  regOverlay.style.display='none';
  afterLogin();
}

/* Login */
async function loginUser(){
  const name = document.getElementById('loginName').value.trim();
  const pass = document.getElementById('loginPass').value;
  if(!name || !pass) return alert('Nombre y contraseña requeridos.');
  const user = loadJSON(STORAGE_USER);
  if(!user) return alert('No hay cuenta registrada en este navegador. Regístrate primero.');
  if(user.name !== name) return alert('Nombre no coincide con la cuenta registrada en este navegador.');
  const passHash = await sha256hex(pass);
  if(passHash !== user.passHash) return alert('Contraseña incorrecta.');
  // session
  localStorage.setItem('rjpii_session', name);
  window.currentUser = name;
  regOverlay.style.display='none';
  afterLogin();
}

/* Logout (for dev/testing) */
function logoutUser(){
  localStorage.removeItem('rjpii_session');
  window.currentUser = null;
  regOverlay.style.display = 'flex';
  showLoginDefault(loadJSON(STORAGE_USER)?.name || '');
}

/* After login: initialize app */
function afterLogin(){
  // show small welcome
  const w = document.createElement('div');
  w.style.position='fixed'; w.style.right='18px'; w.style.top='86px'; w.style.zIndex=999;
  w.style.background='linear-gradient(90deg, rgba(0,198,255,0.08), rgba(30,144,255,0.06))';
  w.style.color='#eaf6ff'; w.style.padding='10px 14px'; w.style.borderRadius='10px'; w.style.boxShadow='0 8px 20px rgba(0,0,0,0.6)';
  w.innerHTML = `Conectado como <strong>${escapeHtml(window.currentUser)}</strong> <button class="smallbtn" style="margin-left:10px;color:#fff" onclick="logoutUser()">Cerrar sesión</button>`;
  document.body.appendChild(w);
  refreshAll();
}

/* ================= GROUPS & POSTS (same as previous app) ================= */

function loadGroups(){ return JSON.parse(localStorage.getItem(STORAGE_GROUPS) || '[]'); }
function saveGroups(list){ localStorage.setItem(STORAGE_GROUPS, JSON.stringify(list)); }
function loadPosts(){ return JSON.parse(localStorage.getItem(STORAGE_POSTS) || '[]'); }
function savePosts(list){ localStorage.setItem(STORAGE_POSTS, JSON.stringify(list)); }

/* Seed sample data if empty (but only after login) */
function seedDataIfEmpty(){
  if(loadGroups().length === 0){
    const g = { id: uid(), name:'Grupo Revolution JPII: Apr', desc:'Espacio general', owner: window.currentUser || 'Admin', members: [window.currentUser || 'Admin'], createdAt: now() };
    saveGroups([g]);
  }
  if(loadPosts().length === 0){
    const p = { id: uid(), author:'FER KIDS', text:'¡Bienvenidos al grupo! Comparte fotos y noticias.', groupId: loadGroups()[0]?.id || '', file: null, comments: [], createdAt: now() };
    savePosts([p]);
  }
}

/* Create group - creatorName can be currentUser or provided */
function createGroup(){
  const ownerInput = document.getElementById('creatorName').value.trim();
  const owner = ownerInput || window.currentUser || '';
  const name = document.getElementById('newGroupName').value.trim();
  const desc = document.getElementById('newGroupDesc').value.trim();
  if(!owner) return alert('Escribe tu nombre para ser el creador del club.');
  if(!name) return alert('Ingresa un nombre para el club.');
  if(containsBanned(owner) || containsBanned(name) || containsBanned(desc)) return alert('Hay palabras no permitidas.');
  const groups = loadGroups();
  const g = { id: uid(), name, desc, owner, members: [owner], createdAt: now() };
  groups.unshift(g);
  saveGroups(groups);
  document.getElementById('creatorName').value='';
  document.getElementById('newGroupName').value='';
  document.getElementById('newGroupDesc').value='';
  refreshAll();
  setTimeout(()=> filterByClub(g.id), 200);
}

/* Only owner can delete club - confirm owner name */
function deleteGroup(id){
  const groups = loadGroups();
  const g = groups.find(x=>x.id===id);
  if(!g) return alert('Club no encontrado.');
  const confirmDelete = confirm('Solo el creador puede eliminar este club. ¿Deseas continuar? (Se eliminarán también las entradas).');
  if(!confirmDelete) return;
  const name = prompt('Para confirmar, escribe el nombre del creador del club:') || '';
  if(name !== g.owner) return alert('Nombre incorrecto. Solo el creador puede eliminar este club.');
  const newGroups = groups.filter(x=>x.id!==id);
  saveGroups(newGroups);
  const posts = loadPosts().filter(p=>p.groupId !== id);
  savePosts(posts);
  refreshAll();
}

/* join/leave */
function joinClub(id){
  const who = prompt('Ingresa tu nombre para unirte al club:') || '';
  if(!who.trim()) return;
  if(containsBanned(who)) return alert('Nombre no permitido.');
  const groups = loadGroups();
  const g = groups.find(x=>x.id===id);
  if(!g) return alert('Club no encontrado.');
  if(!g.members.includes(who)){
    g.members.push(who); saveGroups(groups); refreshAll(); alert('Te uniste al club: ' + g.name);
  } else alert('Ya eres miembro de este club.');
}
function leaveClub(id){
  const who = prompt('Ingresa tu nombre para salir del club:') || '';
  if(!who.trim()) return;
  const groups = loadGroups();
  const g = groups.find(x=>x.id===id); if(!g) return;
  g.members = g.members.filter(m=> m !== who); saveGroups(groups); refreshAll(); alert('Has salido del club.');
}

/* Posts: file input */
const fileInput = document.getElementById('postFileInput');
let pendingFile = null;
if(fileInput){
  fileInput.addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    if(containsBanned(f.name)){ alert('Nombre de archivo no permitido.'); fileInput.value=''; return; }
    try{
      const dataURL = await readFileAsDataURL(f);
      pendingFile = { name: f.name, type: f.type, dataURL };
      renderPendingPreview();
    }catch(e){ alert('Error leyendo archivo.'); }
  });
}
function readFileAsDataURL(file){ return new Promise((res, rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=()=>rej(); r.readAsDataURL(file); }); }
function renderPendingPreview(){
  const preview = document.getElementById('postPreview'); preview.innerHTML = '';
  if(pendingFile){
    const d = document.createElement('div'); d.className='thumb';
    if(pendingFile.type && pendingFile.type.startsWith('image/')){
      const im = document.createElement('img'); im.src = pendingFile.dataURL; im.alt = pendingFile.name; d.appendChild(im);
    } else {
      const a = document.createElement('a'); a.href=pendingFile.dataURL; a.target='_blank'; a.textContent = '📎 ' + pendingFile.name; a.style.color='var(--accent-2)'; d.appendChild(a);
    }
    const del = document.createElement('button'); del.className='del'; del.textContent='✕';
    del.onclick = ()=> { pendingFile=null; if(fileInput) fileInput.value=''; preview.innerHTML=''; }
    d.appendChild(del);
    preview.appendChild(d);
  }
}

/* Create post */
function createPost(){
  const author = document.getElementById('postAuthor').value.trim();
  const text = document.getElementById('postText').value.trim();
  const groupId = document.getElementById('postGroupSelect').value || '';
  if(!author) return alert('Debes ingresar tu nombre antes de publicar.');
  if(containsBanned(author) || containsBanned(text)) return alert('Tu nombre o contenido contiene palabras no permitidas.');
  if(!text && !pendingFile) return alert('Escribe algo o adjunta un archivo antes de publicar.');
  const posts = loadPosts();
  const p = { id: uid(), author, text, groupId, file: pendingFile ? {...pendingFile} : null, comments: [], createdAt: now() };
  posts.unshift(p); savePosts(posts);
  document.getElementById('postAuthor').value=''; document.getElementById('postText').value=''; if(fileInput) fileInput.value='';
  pendingFile = null; renderPendingPreview(); refreshAll();
}

/* Delete post (author only) */
function deletePost(id){
  const posts = loadPosts(); const post = posts.find(p=>p.id===id); if(!post) return;
  const who = prompt('Para eliminar esta entrada, escribe tu nombre (autor):') || '';
  if(who !== post.author) return alert('Solo el autor puede eliminar esta entrada.');
  const newPosts = posts.filter(p=>p.id!==id); savePosts(newPosts); refreshAll();
}

/* delete post image - author only */
function deletePostImage(postId){
  const posts = loadPosts(); const idx = posts.findIndex(p=>p.id===postId); if(idx===-1) return;
  const who = prompt('Para quitar la imagen, escribe tu nombre (autor):') || '';
  if(who !== posts[idx].author) return alert('Solo el autor puede quitar la imagen.');
  posts[idx].file = null; savePosts(posts); refreshAll();
}

/* comments */
function addCommentToPost(postId){
  const who = prompt('Tu nombre (opcional):') || 'Anónimo';
  const text = prompt('Escribe tu comentario:') || '';
  if(!text.trim()) return;
  if(containsBanned(who) || containsBanned(text)) return alert('Comentario no permitido.');
  const posts = loadPosts(); const p = posts.find(x=>x.id===postId); if(!p) return;
  p.comments.push({ id: uid(), who, text, createdAt: now() }); savePosts(posts); refreshAll();
}
function deleteComment(postId, commentId){
  const posts = loadPosts(); const p = posts.find(x=>x.id===postId); if(!p) return;
  const comment = p.comments.find(c=>c.id===commentId); if(!comment) return;
  const who = prompt('Para eliminar este comentario, escribe tu nombre (autor del comentario):') || '';
  if(comment.who !== who) return alert('Solo el autor del comentario puede eliminarlo.');
  p.comments = p.comments.filter(c=>c.id!==commentId); savePosts(posts); refreshAll();
}

/* ================= CAMERA ================= */
let cameraStream = null;
const cameraModal = document.getElementById('cameraModal');
const video = document.getElementById('cameraVideo');

async function openCamera(){
  try{
    cameraModal.style.display='flex';
    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
    video.srcObject = cameraStream; await video.play();
  }catch(err){
    cameraModal.style.display='none';
    alert('No se pudo acceder a la cámara: ' + (err.message || err));
  }
}
function closeCamera(){
  cameraModal.style.display='none';
  if(cameraStream){ cameraStream.getTracks().forEach(t=>t.stop()); cameraStream=null; }
}
function capturePhoto(){
  if(!cameraStream) return;
  const canvas = document.createElement('canvas'); canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d'); ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const dataURL = canvas.toDataURL('image/png');
  pendingFile = { name: 'foto-'+Date.now()+'.png', type: 'image/png', dataURL };
  renderPendingPreview();
  closeCamera();
}

/* ================= RENDERING ================= */

function refreshAll(){
  seedDataIfEmpty();
  renderGroupOptions();
  renderClubList();
  renderFeed();
  renderSelectedClubMembers(null);
}

function renderGroupOptions(){
  const sel = document.getElementById('postGroupSelect'); const filter = document.getElementById('filterByGroup');
  sel.innerHTML = '<option value="">-- Selecciona club (opcional) --</option>'; filter.innerHTML = '<option value="">Ver todo</option>';
  const groups = loadGroups();
  groups.forEach(g=>{
    const o = document.createElement('option'); o.value = g.id; o.textContent = g.name; sel.appendChild(o);
    const o2 = o.cloneNode(true); filter.appendChild(o2);
  });
}

function renderClubList(){
  const container = document.getElementById('clubList'); container.innerHTML='';
  const groups = loadGroups();
  if(groups.length===0){ container.innerHTML = '<div class="note">No hay clubes. Crea uno!</div>'; return; }
  groups.forEach(g=>{
    const wrapper = document.createElement('div'); wrapper.className='club';
    const info = document.createElement('div'); info.className='info';
    info.onclick = ()=> { document.getElementById('filterByGroup').value = g.id; renderFeed(); renderSelectedClubMembers(g.id); scrollToSection('feed'); };
    const title = document.createElement('h4'); title.innerText = g.name;
    const desc = document.createElement('p'); desc.innerText = g.desc || 'Sin descripción';
    info.appendChild(title); info.appendChild(desc);

    const right = document.createElement('div'); right.className='meta-right';
    const count = document.createElement('div'); count.className='count'; count.innerText = g.members.length + ' miembros';
    const btns = document.createElement('div'); btns.style.display='flex'; btns.style.gap='6px';
    const joinBtn = document.createElement('button'); joinBtn.className='btn ghost'; joinBtn.textContent='➕ Unirse';
    joinBtn.onclick = (ev)=>{ ev.stopPropagation(); joinClub(g.id); renderSelectedClubMembers(g.id); };
    const leaveBtn = document.createElement('button'); leaveBtn.className='btn ghost'; leaveBtn.style.padding='6px 8px'; leaveBtn.textContent='Salir';
    leaveBtn.onclick = (ev)=>{ ev.stopPropagation(); leaveClub(g.id); renderSelectedClubMembers(g.id); };
    const delBtn = document.createElement('button'); delBtn.textContent='✕';
    delBtn.title = 'Eliminar (solo creador)'; delBtn.onclick = (ev)=>{ ev.stopPropagation(); deleteGroup(g.id); };
    btns.appendChild(joinBtn); btns.appendChild(leaveBtn); btns.appendChild(delBtn);
    right.appendChild(count); right.appendChild(btns);

    wrapper.appendChild(info); wrapper.appendChild(right);
    container.appendChild(wrapper);
  });
}

function renderSelectedClubMembers(groupId){
  const holder = document.getElementById('selectedClubMembers'); holder.innerHTML = '';
  if(!groupId){ holder.innerHTML = '<div class="note">Selecciona un club para ver los miembros.</div>'; return; }
  const g = loadGroups().find(x=>x.id===groupId);
  if(!g){ holder.innerHTML = '<div class="note">Club no encontrado.</div>'; return; }
  if(!g.members || g.members.length===0){ holder.innerHTML = '<div class="note">Sin miembros.</div>'; return; }
  g.members.forEach(m=>{ const pill = document.createElement('div'); pill.className='member-pill'; pill.innerText = m; holder.appendChild(pill); });
}

function renderFeed(){
  const feed = document.getElementById('feed'); feed.innerHTML='';
  let posts = loadPosts();

  // auto moderation: remove posts with banned words
  const bad = posts.filter(p=> containsBanned(p.author) || containsBanned(p.text) || (p.file && containsBanned(p.file.name)) );
  if(bad.length>0){
    posts = posts.filter(p=> !(containsBanned(p.author) || containsBanned(p.text) || (p.file && containsBanned(p.file.name))) );
    savePosts(posts);
  }

  // filter by group
  const selectedGroup = document.getElementById('filterByGroup').value;
  if(selectedGroup) posts = posts.filter(p=> p.groupId === selectedGroup);

  // search
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  if(q) posts = posts.filter(p => (p.text||'').toLowerCase().includes(q) || (p.author||'').toLowerCase().includes(q));

  if(posts.length === 0){ feed.innerHTML = '<div class="note">No hay entradas aún.</div>'; return; }

  posts.forEach(p=>{
    const div = document.createElement('div'); div.className='post';
    const time = new Date(p.createdAt).toLocaleString();
    const groupName = p.groupId ? (loadGroups().find(g=>g.id===p.groupId)?.name || '') : '';
    const metaHTML = `<div><span class="author">${escapeHtml(p.author)}</span> ${groupName ? '· <span class="muted">'+escapeHtml(groupName)+'</span>' : ''}</div>`;
    const head = document.createElement('div'); head.className='meta';
    head.innerHTML = metaHTML + `<div class="time">${escapeHtml(time)}</div>`;
    const textDiv = document.createElement('div'); textDiv.className='text'; textDiv.innerText = p.text || '';
    div.appendChild(head); div.appendChild(textDiv);

    if(p.file){
      if(p.file.type && p.file.type.startsWith('image/')){
        const img = document.createElement('img'); img.src = p.file.dataURL; img.alt = p.file.name; div.appendChild(img);
      } else {
        const a = document.createElement('a'); a.href = p.file.dataURL; a.target='_blank'; a.textContent = '📎 ' + p.file.name;
        a.style.color = 'var(--accent-2)'; a.style.display='inline-block'; a.style.marginTop='8px'; div.appendChild(a);
      }
    }

    // actions
    const actions = document.createElement('div'); actions.className='actions';
    const like = document.createElement('button'); like.textContent='👍'; like.onclick = ()=> alert('Reaccionaste 👍 (simulado)');
    const commentBtn = document.createElement('button'); commentBtn.textContent='💬 Comentar'; commentBtn.onclick = ()=> addCommentToPost(p.id);
    const delImgBtn = document.createElement('button'); delImgBtn.textContent='🖼️ Quitar foto'; delImgBtn.onclick = ()=> { if(confirm('Quitar imagen de esta entrada?')) deletePostImage(p.id); };
    const delBtn = document.createElement('button'); delBtn.textContent='🗑️ Eliminar'; delBtn.onclick = ()=> deletePost(p.id);
    actions.appendChild(like); actions.appendChild(commentBtn); actions.appendChild(delImgBtn); actions.appendChild(delBtn);
    div.appendChild(actions);

    // comments
    const cm = document.createElement('div'); cm.className='comments';
    if(p.comments && p.comments.length>0){
      p.comments.forEach(c=>{
        const cdiv = document.createElement('div'); cdiv.className='comment';
        cdiv.innerHTML = `<div style="flex:1"><div class="who">${escapeHtml(c.who)}</div><div class="what">${escapeHtml(c.text)}</div></div>
                          <div><button class="smallbtn" onclick="deleteComment('${p.id}','${c.id}')">Eliminar</button></div>`;
        cm.appendChild(cdiv);
      });
    }
    const addc = document.createElement('div'); addc.style.marginTop='6px';
    addc.innerHTML = `<button class="smallbtn" onclick="quickCommentPrompt('${p.id}')">Agregar comentario</button>`; cm.appendChild(addc);
    div.appendChild(cm);

    feed.appendChild(div);
  });
}

function quickCommentPrompt(postId){ addCommentToPost(postId); }

function containsBanned(text){
  if(!text) return false;
  const l = text.toLowerCase();
  return bannedWords.some(b => l.includes(b));
}

function escapeHtml(s){
  if(!s) return '';
  return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
}

/* filter helpers */
function filterByClub(id){ document.getElementById('filterByGroup').value = id; renderFeed(); renderSelectedClubMembers(id); }

/* dev clear */
function clearAll(){ if(!confirm('¿Borrar todos los datos locales (grupos y publicaciones)?')) return; localStorage.removeItem(STORAGE_GROUPS); localStorage.removeItem(STORAGE_POSTS); location.reload(); }

/* scroll helpers */
function scrollToTop(){ window.scrollTo({top:0,behavior:'smooth'}); }
function scrollToSection(id){ const el=document.getElementById(id); if(el) el.scrollIntoView({behavior:'smooth'}); }

/* Wire UI events that may run before script load */
document.getElementById('filterByGroup').addEventListener('change', ()=>{ renderFeed(); renderSelectedClubMembers(document.getElementById('filterByGroup').value || null); });
document.getElementById('searchInput').addEventListener('input', renderFeed);

/* Mobile detection & behavior (ADICIÓN) */
function isMobileDevice(){
  // simple UA test (works for most devices)
  return /Mobi|Android|iPhone|iPad|Phone/i.test(navigator.userAgent);
}
function applyMobileLayoutIfNeeded(){
  if(isMobileDevice()){
    document.body.classList.add('rjpii-mobile');
    // hide right sidebar (already handled by CSS .rjpii-mobile .right { display:none })
    const right = document.querySelector('.right');
    if(right) right.style.display = 'none';
    // show FAB and wire it to focus the create post form
    const fab = document.getElementById('rjpii_fab');
    if(fab){
      fab.style.display = 'block';
      fab.addEventListener('click', ()=>{
        // scroll to create post card and focus author
        const form = document.getElementById('formCreatePost');
        if(form){
          form.scrollIntoView({behavior:'smooth', block:'center'});
          const author = document.getElementById('postAuthor');
          if(author) author.focus();
        }
      });
    }
  } else {
    // ensure FAB hidden on desktop
    const fab = document.getElementById('rjpii_fab');
    if(fab) fab.style.display = 'none';
    // ensure right is visible
    const right = document.querySelector('.right');
    if(right) right.style.display = '';
  }
}

/* Initial bootstrap */
(async function bootstrap(){
  await initAuth(); // shows register/login if needed, or auto-login and call afterLogin()
  // ensure seeds & render done after login
  applyMobileLayoutIfNeeded();
})();
</script>

</body>
</html>
